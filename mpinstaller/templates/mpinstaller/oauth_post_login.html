{% extends 'django_slds/base_slds.html' %}


{% block base_title %}{% if version %}{{ version.package }} {{ version.number }}{% endif %} Installer{% endblock %}

{% block base_head %}
  {% load bootstrap3 %}
  {% bootstrap_javascript jquery=True %}

  <script type="text/javascript">
    {% autoescape off %}
    var actions = {{ actions }};
    var current_action_index = 0;
   
    function run_actions() {
        if (actions.length == current_action_index) {
            $('#console-log .slds-box--body').append('<div>Redirecting to <a href="{{ redirect }}">{{ redirect }}</a></div>');
            //$("html, body").animate({ scrollTop: $(document).height() }, "slow");
            window.location = '{{ redirect }}';
        }
        action = actions[current_action_index];
   
        // Add console log line     
        $('#console-log .slds-box--body').append('<div>' + action['message'] + '</div>');
        //$("html, body").animate({ scrollTop: $(document).height() }, "slow");

        $.ajax({
            url: action['url'],
            type: 'GET',
            success: function () {
                $('#console-log .slds-box--body').append('<div>OK</div>');
                //$("html, body").animate({ scrollTop: $(document).height() }, "slow");
                // Trigger the next action
                setTimeout(function () {run_actions()}, 1000);
            },
            error: function () {
                $('#console-log .slds-box--body').append('<div>OK</div>');
                //$("html, body").animate({ scrollTop: $(document).height() }, "slow");
                // Trigger the next action
                setTimeout(function () {run_actions()}, 1000);
            }
        });

        current_action_index += 1;
    }

    run_actions(actions);

    {% endautoescape %}
  </script>
{% endblock %}

{% block base_page_header %}
<div class="slds-page-header" role="banner">
  <div class="slds-grid">
    <div class="slds-media">
      <div class="slds-media__body">
        <p class="slds-text-heading--label"><a href="/mpinstaller">Installer</a></p>
        <h1 class="slds-text-heading--medium slds-m-right--small slds-truncate slds-align-middle" title="Record Title">
          {% if version %}<a href="{{ version.get_installer_url }}">{{ version.package }} {{ version.number }} Installer</a>{% else %}Installer{% endif %}
        </h1>
        {% if version and version.package.description %}
        <p>{{ version.package.description }}</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block base_body %}

<div id="console-log" class="slds-box">
  <h3 class="slds-box--heading">Examining your Org . . .</h3>
  <div class="slds-box--body">
    <div class="alert alert-info">
      We need to collect some information about your organization. This should only take a few seconds.
    </div>
    {{ message }}
  </div>
</div>

{% endblock %}
